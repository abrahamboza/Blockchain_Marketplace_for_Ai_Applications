{% extends "base_layout.html" %}

{% block title %}Marketplace | Data & ML Models{% endblock %}

{% block additional_styles %}
.marketplace {
    background-color: var(--light-bg);
    min-height: calc(100vh - 200px);
}

.marketplace-header {
    background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
    color: white;
    padding: 3rem 0 2rem;
    margin-bottom: 2rem;
}

.marketplace-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.marketplace-header .lead {
    font-size: 1.1rem;
    opacity: 0.9;
}

.search-hero {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
}

.search-form {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.search-input {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    background: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.search-btn {
    padding: 0.75rem 1.5rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
}

.search-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.quick-filters {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.quick-filter {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.3s;
}

.quick-filter:hover,
.quick-filter.active {
    background: white;
    color: var(--secondary-color);
    border-color: white;
}

.marketplace-content {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
    margin-bottom: 3rem;
}

.sidebar {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    height: fit-content;
    position: sticky;
    top: 120px;
}

.sidebar-section {
    margin-bottom: 2rem;
}

.sidebar-section:last-child {
    margin-bottom: 0;
}

.sidebar-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--gray-200);
}

.filter-group {
    margin-bottom: 1.5rem;
}

.filter-label {
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
    display: block;
}

.filter-select,
.filter-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 0.9rem;
}

.filter-select:focus,
.filter-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.price-range {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 0.5rem;
    align-items: center;
}

.price-separator {
    color: var(--gray-400);
    font-weight: 500;
}

.stats-card {
    background: var(--gray-50);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    display: block;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--gray-600);
    margin-top: 0.25rem;
}

.main-content {
    min-height: 600px;
}

.results-header {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.results-info {
    font-size: 1.1rem;
    color: var(--text-dark);
}

.results-count {
    font-weight: 600;
    color: var(--primary-color);
}

.sort-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sort-label {
    font-weight: 500;
    color: var(--gray-700);
}

.sort-select {
    padding: 0.5rem;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 0.9rem;
}

.view-toggle {
    display: flex;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    overflow: hidden;
}

.view-btn {
    padding: 0.5rem 0.75rem;
    background: white;
    border: none;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.3s;
}

.view-btn.active {
    background: var(--primary-color);
    color: white;
}

.items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.items-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.item-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: all 0.3s;
    cursor: pointer;
    border: 2px solid transparent;
}

.item-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    border-color: var(--primary-color);
}

.item-header {
    padding: 1.5rem 1.5rem 1rem;
    position: relative;
}

.item-type-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
}

.item-type-badge.dataset {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary-color);
}

.item-type-badge.model {
    background: rgba(139, 92, 246, 0.1);
    color: var(--secondary-color);
}

.item-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

.item-owner {
    font-size: 0.85rem;
    color: var(--gray-600);
    margin-bottom: 1rem;
}

.item-description {
    color: var(--gray-700);
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.item-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.item-tag {
    padding: 0.25rem 0.5rem;
    background: var(--gray-100);
    color: var(--gray-600);
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
}

.item-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
}

.meta-item {
    text-align: center;
}

.meta-value {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.9rem;
    display: block;
}

.meta-label {
    font-size: 0.7rem;
    color: var(--gray-500);
    text-transform: uppercase;
    margin-top: 0.25rem;
}

.item-footer {
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
}

.item-price {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--success-color);
}

.quality-score {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--gray-600);
}

.score-stars {
    color: var(--warning-color);
}

.list-item {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1.5rem;
    align-items: center;
    transition: all 0.3s;
    cursor: pointer;
}

.list-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.list-item-info {
    flex: 1;
}

.list-item-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.list-item-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--gray-600);
}

.list-item-price {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--success-color);
}

.no-results {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.no-results i {
    font-size: 4rem;
    color: var(--gray-400);
    margin-bottom: 1rem;
}

.no-results h3 {
    color: var(--text-dark);
    margin-bottom: 1rem;
}

.no-results p {
    color: var(--gray-600);
    margin-bottom: 2rem;
}

.clear-filters-btn {
    padding: 0.75rem 1.5rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
}

.clear-filters-btn:hover {
    background: var(--primary-dark);
    color: white;
}

.loading-spinner {
    text-align: center;
    padding: 3rem;
    color: var(--gray-500);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.active-filters {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.active-filters h6 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.filter-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.filter-tag {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-tag .remove {
    cursor: pointer;
    font-weight: bold;
}

@media (max-width: 1024px) {
    .marketplace-content {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .sidebar {
        position: static;
        margin-bottom: 1rem;
    }
    
    .items-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }
}

@media (max-width: 768px) {
    .marketplace-header h1 {
        font-size: 2rem;
    }
    
    .search-form {
        flex-direction: column;
    }
    
    .results-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .items-grid {
        grid-template-columns: 1fr;
    }
    
    .list-item {
        grid-template-columns: 1fr;
        text-align: center;
    }
    
    .quick-filters {
        justify-content: center;
    }
}
{% endblock %}

{% block content %}
<div class="marketplace">
    <!-- Marketplace Header -->
    <section class="marketplace-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1><i class="bi bi-shop me-3"></i>Data Marketplace</h1>
                    <p class="lead mb-0">Entdecke, kaufe und verkaufe ML-Datensätze und Modelle auf der Blockchain</p>
                </div>
                <div class="col-lg-6">
                    <div class="search-hero">
                        <form class="search-form" method="GET" action="/marketplace">
                            <input type="text" class="search-input" name="search" 
                                   placeholder="Suche nach Datensätzen, Modellen oder Tags..." 
                                   value="{{ filters.search or '' }}">
                            <button type="submit" class="search-btn">
                                <i class="bi bi-search me-2"></i>Suchen
                            </button>
                        </form>
                        
                        <div class="quick-filters">
                            <a href="/marketplace" class="quick-filter {{ 'active' if not filters.type or filters.type == 'all' else '' }}">
                                <i class="bi bi-grid me-1"></i>Alle Items
                            </a>
                            <a href="/marketplace?type=data" class="quick-filter {{ 'active' if filters.type == 'data' else '' }}">
                                <i class="bi bi-database me-1"></i>Datensätze
                            </a>
                            <a href="/marketplace?type=models" class="quick-filter {{ 'active' if filters.type == 'models' else '' }}">
                                <i class="bi bi-cpu me-1"></i>ML-Modelle
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <div class="marketplace-content">
            <!-- Sidebar with Filters -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="bi bi-funnel me-2"></i>Filter
                    </h3>

                    <form method="GET" action="/marketplace" id="filter-form">
                        <!-- Keep search query -->
                        {% if filters.search %}
                        <input type="hidden" name="search" value="{{ filters.search }}">
                        {% endif %}

                        <div class="filter-group">
                            <label class="filter-label">Typ</label>
                            <select name="type" class="filter-select" onchange="submitForm()">
                                <option value="all" {{ 'selected' if filters.type == 'all' or not filters.type else '' }}>Alle</option>
                                <option value="data" {{ 'selected' if filters.type == 'data' else '' }}>Datensätze</option>
                                <option value="models" {{ 'selected' if filters.type == 'models' else '' }}>ML-Modelle</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Kategorie</label>
                            <select name="category" class="filter-select" onchange="submitForm()">
                                <option value="">Alle Kategorien</option>
                                {% for category in stats.categories %}
                                <option value="{{ category }}" {{ 'selected' if filters.category == category else '' }}>
                                    {{ category }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Preisspanne ($)</label>
                            <div class="price-range">
                                <input type="number" name="price_min" class="filter-input"
                                       placeholder="Min" value="{{ filters.price_min or '' }}"
                                       min="0" step="0.01">
                                <span class="price-separator">-</span>
                                <input type="number" name="price_max" class="filter-input"
                                       placeholder="Max" value="{{ filters.price_max or '' }}"
                                       min="0" step="0.01">
                            </div>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Sortierung</label>
                            <select name="sort" class="filter-select" onchange="submitForm()">
                                <option value="newest" {{ 'selected' if filters.sort == 'newest' else '' }}>Neueste</option>
                                <option value="oldest" {{ 'selected' if filters.sort == 'oldest' else '' }}>Älteste</option>
                                <option value="price_low" {{ 'selected' if filters.sort == 'price_low' else '' }}>Preis: Niedrig → Hoch</option>
                                <option value="price_high" {{ 'selected' if filters.sort == 'price_high' else '' }}>Preis: Hoch → Niedrig</option>
                                <option value="name" {{ 'selected' if filters.sort == 'name' else '' }}>Name A-Z</option>
                            </select>
                        </div>

                        <button type="submit" class="clear-filters-btn w-100 mt-3">
                            <i class="bi bi-check me-2"></i>Filter anwenden
                        </button>
                    </form>

                    {% if filters.search or filters.category or (filters.type and filters.type != 'all') or filters.price_min or filters.price_max %}
                    <a href="/marketplace" class="clear-filters-btn w-100 mt-2" style="background: var(--gray-500);">
                        <i class="bi bi-x me-2"></i>Filter zurücksetzen
                    </a>
                    {% endif %}
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">
                        <i class="bi bi-bar-chart me-2"></i>Statistiken
                    </h3>

                    <div class="stats-card mb-3">
                        <span class="stat-number">{{ stats.total_items }}</span>
                        <div class="stat-label">Gesamt Items</div>
                    </div>

                    <div class="stats-card mb-3">
                        <span class="stat-number">{{ stats.datasets }}</span>
                        <div class="stat-label">Datensätze</div>
                    </div>

                    <div class="stats-card mb-3">
                        <span class="stat-number">{{ stats.models }}</span>
                        <div class="stat-label">ML-Modelle</div>
                    </div>

                    <div class="stats-card">
                        <span class="stat-number">${{ "%.0f"|format(stats.avg_price) }}</span>
                        <div class="stat-label">Ø Preis</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Results Header -->
                <div class="results-header">
                    <div class="results-info">
                        <span class="results-count">{{ stats.filtered_count }}</span>
                        von {{ stats.total_items }} Items
                        {% if filters.search %}
                        für "<strong>{{ filters.search }}</strong>"
                        {% endif %}
                    </div>

                    <div class="sort-controls">
                        <div class="view-toggle">
                            <button class="view-btn active" onclick="switchView('grid')" id="grid-btn">
                                <i class="bi bi-grid"></i>
                            </button>
                            <button class="view-btn" onclick="switchView('list')" id="list-btn">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Active Filters Display -->
                {% set active_filters = [] %}
                {% if filters.type and filters.type != 'all' %}{% set _ = active_filters.append(('Typ', filters.type.title())) %}{% endif %}
                {% if filters.category %}{% set _ = active_filters.append(('Kategorie', filters.category)) %}{% endif %}
                {% if filters.search %}{% set _ = active_filters.append(('Suche', filters.search)) %}{% endif %}
                {% if filters.price_min %}{% set _ = active_filters.append(('Min. Preis', '$' + filters.price_min|string)) %}{% endif %}
                {% if filters.price_max %}{% set _ = active_filters.append(('Max. Preis', '$' + filters.price_max|string)) %}{% endif %}

                {% if active_filters %}
                <div class="active-filters">
                    <h6><i class="bi bi-filter me-2"></i>Aktive Filter:</h6>
                    <div class="filter-tags">
                        {% for label, value in active_filters %}
                        <span class="filter-tag">
                            {{ label }}: {{ value }}
                            <span class="remove" onclick="removeFilter('{{ label }}')">&times;</span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Items Display -->
                {% if items %}
                <!-- Grid View -->
                <div class="items-grid" id="grid-view">
                    {% for item in items %}
                    <div class="item-card" onclick="viewItem('{{ item.id }}')">
                        <div class="item-header">
                            <span class="item-type-badge {{ item.type }}">{{ item.type.title() }}</span>
                            <h3 class="item-title">{{ item.name }}</h3>
                            <div class="item-owner">
                                <i class="bi bi-person me-1"></i>{{ format_address(item.owner) }}
                            </div>
                            <p class="item-description">{{ item.description }}</p>

                            {% if item.tags %}
                            <div class="item-tags">
                                {% for tag in item.tags[:4] %}
                                <span class="item-tag">{{ tag }}</span>
                                {% endfor %}
                                {% if item.tags|length > 4 %}
                                <span class="item-tag">+{{ item.tags|length - 4 }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="item-meta">
                            {% if item.type == 'dataset' %}
                            <div class="meta-item">
                                <span class="meta-value">{{ "{:,}".format(item.samples) }}</span>
                                <div class="meta-label">Samples</div>
                            </div>
                            <div class="meta-item">
                                <span class="meta-value">{{ item.features }}</span>
                                <div class="meta-label">Features</div>
                            </div>
                            {% else %}
                            <div class="meta-item">
                                <span class="meta-value">{{ item.accuracy }}</span>
                                <div class="meta-label">Accuracy</div>
                            </div>
                            <div class="meta-item">
                                <span class="meta-value">{{ item.framework }}</span>
                                <div class="meta-label">Framework</div>
                            </div>
                            {% endif %}
                            <div class="meta-item">
                                <span class="meta-value">{{ item.size }}</span>
                                <div class="meta-label">Size</div>
                            </div>
                            <div class="meta-item">
                                <span class="meta-value">{{ item.category }}</span>
                                <div class="meta-label">Category</div>
                            </div>
                        </div>

                        <div class="item-footer">
                            <div class="item-price">${{ "%.2f"|format(item.price) }}</div>
                            {% if item.quality_score > 0 %}
                            <div class="quality-score">
                                <span class="score-stars">
                                    {% for i in range((item.quality_score / 2)|int) %}★{% endfor %}
                                </span>
                                {{ "%.1f"|format(item.quality_score) }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- List View (Hidden by default) -->
                <div class="items-list" id="list-view" style="display: none;">
                    {% for item in items %}
                    <div class="list-item" onclick="viewItem('{{ item.id }}')">
                        <div class="item-type-badge {{ item.type }}">{{ item.type.title() }}</div>
                        <div class="list-item-info">
                            <h3 class="list-item-title">{{ item.name }}</h3>
                            <div class="list-item-meta">
                                <span><i class="bi bi-person me-1"></i>{{ format_address(item.owner) }}</span>
                                <span><i class="bi bi-calendar me-1"></i>{{ item.formatted_date }}</span>
                                <span><i class="bi bi-tag me-1"></i>{{ item.category }}</span>
                                {% if item.quality_score > 0 %}
                                <span><i class="bi bi-star me-1"></i>{{ "%.1f"|format(item.quality_score) }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="list-item-price">${{ "%.2f"|format(item.price) }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- No Results -->
                <div class="no-results">
                    <i class="bi bi-search"></i>
                    <h3>Keine Ergebnisse gefunden</h3>
                    <p>Deine Suche hat keine passenden Items ergeben. Versuche andere Filter oder Suchbegriffe.</p>
                    <a href="/marketplace" class="clear-filters-btn">
                        <i class="bi bi-arrow-clockwise me-2"></i>Alle Filter zurücksetzen
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
   // Initialize marketplace
   console.log('Marketplace loaded with {{ stats.filtered_count }} items');

   // Auto-submit form on filter changes (with debounce)
   let filterTimeout;
   const priceInputs = document.querySelectorAll('input[name="price_min"], input[name="price_max"]');

   priceInputs.forEach(input => {
       input.addEventListener('input', function() {
           clearTimeout(filterTimeout);
           filterTimeout = setTimeout(() => {
               document.getElementById('filter-form').submit();
           }, 1000); // Wait 1 second after user stops typing
       });
   });
});

// Form submission helper
function submitForm() {
   document.getElementById('filter-form').submit();
}

// View switching
function switchView(viewType) {
   const gridView = document.getElementById('grid-view');
   const listView = document.getElementById('list-view');
   const gridBtn = document.getElementById('grid-btn');
   const listBtn = document.getElementById('list-btn');

   if (viewType === 'grid') {
       gridView.style.display = 'grid';
       listView.style.display = 'none';
       gridBtn.classList.add('active');
       listBtn.classList.remove('active');
       localStorage.setItem('marketplace-view', 'grid');
   } else {
       gridView.style.display = 'none';
       listView.style.display = 'flex';
       gridBtn.classList.remove('active');
       listBtn.classList.add('active');
       localStorage.setItem('marketplace-view', 'list');
   }
}

// Restore saved view preference
document.addEventListener('DOMContentLoaded', function() {
   const savedView = localStorage.getItem('marketplace-view');
   if (savedView === 'list') {
       switchView('list');
   }
});

// Navigate to item details
function viewItem(itemId) {
   window.location.href = `/marketplace/item/${itemId}`;
}

// Remove individual filters
function removeFilter(filterType) {
   const form = document.getElementById('filter-form');
   const url = new URL(window.location);

   switch(filterType) {
       case 'Typ':
           url.searchParams.set('type', 'all');
           break;
       case 'Kategorie':
           url.searchParams.delete('category');
           break;
       case 'Suche':
           url.searchParams.delete('search');
           break;
       case 'Min. Preis':
           url.searchParams.delete('price_min');
           break;
       case 'Max. Preis':
           url.searchParams.delete('price_max');
           break;
   }

   window.location.href = url.toString();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
   // Focus search on '/' key
   if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
       e.preventDefault();
       document.querySelector('input[name="search"]').focus();
   }

   // Toggle view with 'v' key
   if (e.key === 'v' || e.key === 'V') {
       if (!e.ctrlKey && !e.metaKey) {
           e.preventDefault();
           const currentView = localStorage.getItem('marketplace-view') || 'grid';
           switchView(currentView === 'grid' ? 'list' : 'grid');
       }
   }

   // Clear filters with 'c' key
   if (e.key === 'c' || e.key === 'C') {
       if (!e.ctrlKey && !e.metaKey) {
           e.preventDefault();
           window.location.href = '/marketplace';
       }
   }
});

// Add loading states to item cards
document.querySelectorAll('.item-card, .list-item').forEach(card => {
   card.addEventListener('click', function() {
       this.style.opacity = '0.7';
       this.style.transform = 'scale(0.98)';
   });
});

// Price range validation
const priceMinInput = document.querySelector('input[name="price_min"]');
const priceMaxInput = document.querySelector('input[name="price_max"]');

if (priceMinInput && priceMaxInput) {
   priceMinInput.addEventListener('change', function() {
       const minValue = parseFloat(this.value);
       const maxValue = parseFloat(priceMaxInput.value);

       if (minValue && maxValue && minValue > maxValue) {
           priceMaxInput.value = minValue;
       }
   });

   priceMaxInput.addEventListener('change', function() {
       const minValue = parseFloat(priceMinInput.value);
       const maxValue = parseFloat(this.value);

       if (minValue && maxValue && maxValue < minValue) {
           priceMinInput.value = maxValue;
       }
   });
}

// Search input enhancements
const searchInput = document.querySelector('input[name="search"]');
if (searchInput) {
   let searchTimeout;

   searchInput.addEventListener('input', function() {
       clearTimeout(searchTimeout);
       const query = this.value.trim();

       if (query.length > 2) {
           searchTimeout = setTimeout(() => {
               console.log('Search suggestions for:', query);
           }, 300);
       }
   });
}

// Form validation
const form = document.getElementById('filter-form');
if (form) {
   form.addEventListener('submit', function(e) {
       const priceMin = priceMinInput ? priceMinInput.value : '';
       const priceMax = priceMaxInput ? priceMaxInput.value : '';

       if (priceMin && priceMax && parseFloat(priceMin) > parseFloat(priceMax)) {
           e.preventDefault();
           alert('Der Mindestpreis kann nicht höher als der Höchstpreis sein.');
           return false;
       }

       // Show loading state
       const submitBtn = this.querySelector('button[type="submit"]');
       if (submitBtn) {
           submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Lädt...';
           submitBtn.disabled = true;
       }
   });
}

// Analytics tracking (placeholder for future enhancement)
function trackItemView(itemId) {
   console.log('Item viewed:', itemId);
   // Send analytics event
}

function trackFilterUsage(filterType, value) {
   console.log('Filter used:', filterType, value);
   // Send analytics event
}

// Quick filter tracking
document.querySelectorAll('.quick-filter').forEach(filter => {
   filter.addEventListener('click', function() {
       const filterType = this.textContent.trim();
       trackFilterUsage('quick-filter', filterType);
   });
});

// Connection status monitoring
let connectionLost = false;

window.addEventListener('online', function() {
   if (connectionLost) {
       location.reload();
   }
});

window.addEventListener('offline', function() {
   connectionLost = true;
   console.warn('Connection lost - marketplace updates paused');
});
</script>
{% endblock %}